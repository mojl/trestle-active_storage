<div class="nested-fields-container">
  <%= builder.fields_for field_name do %>
    <div class="active-storage" id="stored_images">
      <% if attachments.attached? && builder.object.persisted?  %>
        <% attachments.order(order: :asc).each do |attachment| %>
          <div class="active-storage__preview stored_image" draggable="true">
            <% if attachment.previewable? %>
              <%= image_tag(main_app.url_for(attachment.preview(resize_to_limit: [300, 300])), class: "active-storage__image", draggable: "false") %>
            <% elsif attachment.variable? %>
              <%= image_tag(main_app.url_for(attachment.variant(resize_to_limit: [300, 300])), class: "active-storage__image", draggable: "false") %>
            <% end %>
            <% if attachment.persisted? %>
              <div>
                <small><%= attachment.blob.filename %></small>
                <%= builder.check_box("delete_#{field_name}_#{attachment.blob_id.to_s.gsub('-', '')}", label: "Delete this #{field_name.to_s.singularize}") %>
              </div>
            <% else %>
              <small><%= attachment.blob.filename %></small>
            <% end %>
            <div>
              <%= link_to main_app.rails_blob_path(attachment, disposition: "attachment"), draggable: "false" do %>
              <span class="btn-label">Download</span>
            <% end %>
            </div>
            <%= builder.hidden_field("order_#{field_name}_#{attachment.blob_id.to_s.gsub('-', '')}", value: attachment.order, class: "order_image") %>
          </div>
        <% end %>
      <% end %>
    </div>

    <%= builder.raw_file_field(field_name, class: 'active-storage__field', multiple: true, direct_upload: true) %>
  <% end %>
</div>
